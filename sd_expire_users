#!/bin/bash

mysql -u dave -p -h sdedtsql01 -N -s -r -D sd_app -e "SELECT SQL_NO_CACHE tbl.user_id, tbl.last_expire, tbl.nbpro, log.last_login, tbl.lang_gui, tbl.email, tbl.username, tbl.unique_code, tbl.email_enable, tbl.email_confirmed FROM (SELECT SQL_NO_CACHE lang_gui, email, username, unique_code, email_enable, email_confirmed, user_id, DATEDIFF(MAX(w_site.dt_expire), CURDATE()) AS last_expire, SUM(IF(mode='pro', 1, 0)) AS nbpro FROM w_site, w_user WHERE w_site.user_id = w_user.id AND w_user.group = 'user' AND DATEDIFF(CURDATE(), w_user.dt_create)>0 GROUP BY w_site.user_id HAVING SUM(published)=0) AS tbl LEFT JOIN (SELECT SQL_NO_CACHE user_id, DATEDIFF(MAX(dt), CURDATE()) AS last_login FROM w_log WHERE type='login' GROUP BY user_id) AS log ON tbl.user_id=log.user_id;"
#mysql -u dave -p -h sdedtsql01 -D sd_app -e "SELECT SQL_NO_CACHE tbl.user_id, tbl.last_expire, tbl.nbpro, log.last_login, tbl.lang_gui, tbl.email, tbl.username, tbl.unique_code, tbl.email_enable, tbl.email_confirmed FROM (SELECT SQL_NO_CACHE lang_gui, email, username, unique_code, email_enable, email_confirmed, user_id, DATEDIFF(MAX(w_site.dt_expire), CURDATE()) AS last_expire, SUM(IF(mode='pro', 1, 0)) AS nbpro FROM w_site, w_user WHERE w_site.user_id = w_user.id AND w_user.group = 'user' AND DATEDIFF(CURDATE(), w_user.dt_create)>0 GROUP BY w_site.user_id HAVING SUM(published)=0) AS tbl LEFT JOIN (SELECT SQL_NO_CACHE user_id, DATEDIFF(MAX(dt), CURDATE()) AS last_login FROM w_log WHERE type='login' GROUP BY user_id) AS log ON tbl.user_id=log.user_id;"
